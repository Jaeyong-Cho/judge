<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Function Call Graph Viewer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-light.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: #fafafa;
            color: #383a42;
        }
        
        header {
            background: #ffffff;
            padding: 1rem 2rem;
            border-bottom: 1px solid #e5e5e6;
        }
        
        h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #383a42;
            margin-bottom: 0.5rem;
        }
        
        .project-directory {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .project-directory label {
            font-size: 0.875rem;
            color: #9196a1;
            font-weight: 500;
        }
        
        .project-directory input {
            flex: 1;
            padding: 0.375rem 0.75rem;
            border: 1px solid #d0d0d0;
            border-radius: 4px;
            font-size: 0.875rem;
            font-family: 'Courier New', monospace;
            background: #fafafa;
            color: #383a42;
        }
        
        .project-directory input:focus {
            outline: none;
            border-color: #4078f2;
            background: #ffffff;
        }
        
        .btn-secondary {
            background: #50a14f;
            color: white;
            padding: 0.375rem 0.75rem;
            font-size: 0.875rem;
        }
        
        .btn-secondary:hover {
            background: #5fb95e;
        }
        
        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .sidebar {
            width: 350px;
            background: #f0f0f0;
            border-right: 1px solid #d0d0d0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .sidebar-header {
            padding: 1rem;
            background: #ffffff;
            border-bottom: 1px solid #d0d0d0;
        }
        
        .sidebar-header h2 {
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            color: #383a42;
            margin-bottom: 0.5rem;
        }
        
        .sidebar-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #4078f2;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a8ff5;
        }
        
        .function-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }
        
        .file-group {
            margin-bottom: 1rem;
        }
        
        .file-name {
            padding: 0.5rem;
            background: #e5e5e6;
            font-weight: 600;
            font-size: 0.875rem;
            color: #383a42;
            border-radius: 4px;
            margin-bottom: 0.25rem;
        }
        
        .tree-folder {
            margin-bottom: 0.25rem;
        }
        
        .tree-folder-header {
            padding: 0.5rem;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            user-select: none;
        }
        
        .tree-folder-header:hover {
            background: #e5e5e6;
        }
        
        .tree-folder-icon {
            font-size: 0.75rem;
            transition: transform 0.2s;
            color: #9196a1;
        }
        
        .tree-folder-header.expanded .tree-folder-icon {
            transform: rotate(90deg);
        }
        
        .tree-folder-name {
            font-weight: 500;
            color: #50a14f;
        }
        
        .tree-folder-children {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            padding-left: 1rem;
        }
        
        .tree-folder-children.expanded {
            max-height: 3000px;
            transition: max-height 0.5s ease-in;
        }
        
        .tree-file {
            padding: 0.5rem;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            margin-bottom: 0.125rem;
        }
        
        .tree-file:hover {
            background: #e5e5e6;
        }
        
        .tree-file.expanded {
            background: #f0f0f0;
        }
        
        .tree-file-icon {
            font-size: 0.75rem;
            transition: transform 0.2s;
            color: #9196a1;
        }
        
        .tree-file.expanded .tree-file-icon {
            transform: rotate(90deg);
        }
        
        .tree-file-name {
            font-weight: 500;
            color: #c18401;
            flex: 1;
        }
        
        .tree-file-functions {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            padding-left: 1.5rem;
        }
        
        .tree-file-functions.expanded {
            max-height: 2000px;
            transition: max-height 0.5s ease-in;
        }
        
        .function-item {
            padding: 0.5rem;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.2s;
            font-size: 0.875rem;
            margin-bottom: 0.125rem;
        }
        
        .function-item:hover {
            background: #e5e5e6;
        }
        
        .function-item.active {
            background: #4078f2;
            color: white;
        }
        
        .function-item-name {
            font-weight: 500;
            color: #a626a4;
        }
        
        .function-item.active .function-item-name {
            color: white;
        }
        
        .function-item-info {
            font-size: 0.75rem;
            color: #9196a1;
            margin-top: 0.125rem;
        }
        
        .function-item.active .function-item-info {
            color: rgba(255, 255, 255, 0.8);
        }
        
        .tree-view {
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            line-height: 1.5;
            white-space: pre;
            color: #383a42;
        }
        
        .tree-item {
            padding: 0.125rem 0;
        }
        
        .tree-item-dir {
            color: #50a14f;
            font-weight: 500;
        }
        
        .tree-item-file {
            color: #c18401;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .content-header {
            padding: 1rem 2rem;
            background: #ffffff;
            border-bottom: 1px solid #d0d0d0;
        }
        
        .content-header h2 {
            font-size: 1.125rem;
            font-weight: 600;
            color: #383a42;
        }
        
        .content-body {
            flex: 1;
            overflow: auto;
            padding: 2rem;
        }
        
        .content-wrapper {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            max-width: 100%;
        }
        
        .graph-container {
            max-width: 100%;
            background: white;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid #d0d0d0;
            position: relative;
            overflow: hidden;
            cursor: grab;
        }
        
        .graph-container.grabbing {
            cursor: grabbing;
        }
        
        .graph-container svg {
            max-width: 100%;
            height: auto;
            transition: transform 0.1s ease-out;
        }
        
        .zoom-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 10;
        }
        
        .zoom-btn {
            width: 32px;
            height: 32px;
            background: #FFFFFF;
            border: 1px solid #D0D0D0;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            color: #383A42;
            transition: all 0.2s;
        }
        
        .zoom-btn:hover {
            background: #F0F0F0;
            border-color: #4078F2;
        }
        
        .zoom-btn:active {
            background: #E0E0E0;
        }
        
        .zoom-info {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #D0D0D0;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            color: #383A42;
            z-index: 10;
        }
        
        .code-viewer {
            background: white;
            border: 1px solid #d0d0d0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .code-viewer-header {
            background: #e5e5e6;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #d0d0d0;
            font-size: 0.875rem;
            font-weight: 500;
            color: #383a42;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .code-viewer-body {
            overflow-x: auto;
            background: #fafafa;
        }
        
        .code-viewer pre {
            margin: 0;
            padding: 1rem;
        }
        
        .code-viewer code {
            font-family: 'Courier New', 'Menlo', 'Monaco', monospace;
            font-size: 0.875rem;
            line-height: 1.6;
            font-weight: 500;
        }
        
        .hljs-keyword {
            color: #a626a4;
            font-weight: 600;
        }
        
        .code-viewer code .hljs-keyword:has-text("assert"),
        .code-viewer code span:contains("assert") {
            background-color: #fff3cd;
            padding: 0.125rem 0.25rem;
            border-radius: 3px;
            color: #e45649;
            font-weight: 700;
        }
        
        .highlight-caller {
            background-color: #d4edda !important;
            border-bottom: 2px solid #28a745 !important;
            padding: 0.125rem 0.25rem;
            border-radius: 3px;
            font-weight: 600;
            cursor: help;
        }
        
        .highlight-callee {
            background-color: #d1ecf1 !important;
            border-bottom: 2px solid #17a2b8 !important;
            padding: 0.125rem 0.25rem;
            border-radius: 3px;
            font-weight: 600;
            cursor: help;
        }
        
        .highlight-current {
            background-color: #fff3cd !important;
            border-bottom: 2px solid #ffc107 !important;
            padding: 0.125rem 0.25rem;
            border-radius: 3px;
            font-weight: 700;
            cursor: help;
        }
        
        .function-legend {
            display: flex;
            gap: 1rem;
            padding: 0.75rem 1rem;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 1rem;
            font-size: 0.813rem;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .legend-box {
            width: 20px;
            height: 14px;
            border-radius: 3px;
            border: 1px solid rgba(0,0,0,0.1);
        }
        
        .legend-caller {
            background-color: #d4edda;
            border-bottom: 2px solid #28a745;
        }
        
        .legend-callee {
            background-color: #d1ecf1;
            border-bottom: 2px solid #17a2b8;
        }
        
        .legend-current {
            background-color: #fff3cd;
            border-bottom: 2px solid #ffc107;
        }
        
        .collapsible-section {
            background: white;
            border: 1px solid #d0d0d0;
            border-radius: 8px;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .collapsible-header {
            background: #f0f0f0;
            padding: 0.75rem 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            transition: background 0.2s;
        }
        
        .collapsible-header:hover {
            background: #e5e5e6;
        }
        
        .collapsible-header.active {
            background: #e5e5e6;
            border-bottom: 1px solid #d0d0d0;
        }
        
        .collapsible-title {
            font-size: 0.938rem;
            font-weight: 600;
            color: #383a42;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .collapsible-badge {
            display: inline-block;
            background: #4078f2;
            color: white;
            padding: 0.125rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .collapsible-toggle {
            font-size: 1.25rem;
            color: #9196a1;
            transition: transform 0.2s;
        }
        
        .collapsible-header.active .collapsible-toggle {
            transform: rotate(90deg);
        }
        
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        .collapsible-content.expanded {
            max-height: 5000px;
            transition: max-height 0.5s ease-in;
        }
        
        .collapsible-body {
            padding: 0;
        }
        
        .function-code-item {
            border-top: 1px solid #e5e5e6;
        }
        
        .function-code-item:first-child {
            border-top: none;
        }
        
        .function-code-header {
            background: #fafafa;
            padding: 0.5rem 1rem;
            font-size: 0.813rem;
            color: #383a42;
            border-bottom: 1px solid #e5e5e6;
        }
        
        .function-code-meta {
            color: #9196a1;
            font-size: 0.75rem;
        }
        
        .assertions-section {
            background: white;
            border: 1px solid #d0d0d0;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
        }
        
        .assertions-header {
            font-size: 0.875rem;
            font-weight: 600;
            color: #383a42;
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e5e5e6;
        }
        
        .assertion-item {
            padding: 0.5rem;
            background: #fafafa;
            border: 1px solid #e5e5e6;
            border-radius: 4px;
            margin-bottom: 0.5rem;
            font-family: 'Courier New', monospace;
            font-size: 0.813rem;
            color: #383a42;
        }
        
        .assertion-badge {
            display: inline-block;
            background: #50a14f;
            color: white;
            padding: 0.125rem 0.375rem;
            border-radius: 3px;
            font-size: 0.688rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }
        
        .no-assertions {
            color: #9196a1;
            font-style: italic;
            font-size: 0.813rem;
        }
        
        .assertions-summary {
            background: #e8f4ff;
            border: 1px solid #4078f2;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .assertions-summary h3 {
            font-size: 1rem;
            color: #383a42;
            margin-bottom: 0.75rem;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.875rem;
        }
        
        .stat-label {
            color: #383a42;
            font-weight: 500;
        }
        
        .stat-value {
            color: #4078f2;
            font-weight: 600;
            font-size: 1.125rem;
        }
        
        .function-assertions-list {
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .function-assertion-card {
            background: white;
            border: 1px solid #d0d0d0;
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .function-assertion-card h4 {
            font-size: 0.938rem;
            color: #a626a4;
            margin-bottom: 0.5rem;
        }
        
        .function-meta {
            font-size: 0.75rem;
            color: #9196a1;
            margin-bottom: 0.75rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #9196a1;
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: #9196a1;
        }
        
        .spinner {
            border: 3px solid #e5e5e6;
            border-top: 3px solid #4078f2;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f0f0f0;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body>
    <header>
        <h1>Function Call Graph Viewer</h1>
        <div class="project-directory">
            <label>Workspace:</label>
            <input type="text" id="projectDirInput" placeholder="/path/to/project">
            <button class="btn btn-secondary" onclick="setProjectDirectory()">Set Directory</button>
            <button class="btn btn-primary" onclick="loadFunctions()">Reload</button>
        </div>
    </header>
    
    <div class="container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>Project Functions</h2>
                <div class="sidebar-actions">
                    <button class="btn btn-primary" onclick="loadProjectGraph()">Project Graph</button>
                    <button class="btn btn-primary" onclick="showAssertions()">Assertions</button>
                </div>
            </div>
            <div class="function-list" id="functionList">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading functions...</p>
                </div>
            </div>
        </aside>
        
        <main class="main-content">
            <div class="content-header">
                <h2 id="graphTitle">Select a function to view its call graph</h2>
            </div>
            <div class="content-body" id="graphContent">
                <div class="empty-state">
                    <div class="empty-state-icon">üìä</div>
                    <h3>No graph selected</h3>
                    <p>Click on a function from the list or generate the project graph</p>
                </div>
            </div>
        </main>
    </div>
    
    <script>
        let currentFunction = null;
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        async function loadFunctions() {
            const listElement = document.getElementById('functionList');
            listElement.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading functions...</p></div>';
            
            try {
                const response = await fetch('/api/project/structure');
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to load functions');
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                listElement.innerHTML = '';
                
                const filePaths = Object.keys(data);
                
                if (filePaths.length === 0) {
                    listElement.innerHTML = '<div class="empty-state"><p>No Python files found in directory</p></div>';
                    return;
                }
                
                const tree = buildDirectoryTree(data);
                renderTree(tree, listElement);
                
            } catch (error) {
                console.error('Error loading functions:', error);
                listElement.innerHTML = 
                    `<div class="empty-state"><p>Error: ${error.message}</p></div>`;
            }
        }
        
        function buildDirectoryTree(data) {
            const tree = {};
            
            for (const [filePath, fileData] of Object.entries(data)) {
                const parts = filePath.split('/');
                let current = tree;
                
                for (let i = 0; i < parts.length; i++) {
                    const part = parts[i];
                    
                    if (i === parts.length - 1) {
                        current[part] = {
                            type: 'file',
                            path: filePath,
                            data: fileData
                        };
                    } else {
                        if (!current[part]) {
                            current[part] = {
                                type: 'folder',
                                children: {}
                            };
                        }
                        current = current[part].children;
                    }
                }
            }
            
            return tree;
        }
        
        function renderTree(tree, container, level = 0) {
            const entries = Object.entries(tree).sort((a, b) => {
                const aIsFolder = a[1].type === 'folder';
                const bIsFolder = b[1].type === 'folder';
                if (aIsFolder && !bIsFolder) return -1;
                if (!aIsFolder && bIsFolder) return 1;
                return a[0].localeCompare(b[0]);
            });
            
            for (const [name, node] of entries) {
                if (node.type === 'folder') {
                    const folder = document.createElement('div');
                    folder.className = 'tree-folder';
                    
                    const folderHeader = document.createElement('div');
                    folderHeader.className = 'tree-folder-header';
                    folderHeader.innerHTML = `
                        <span class="tree-folder-icon">‚ñ∂</span>
                        <span class="tree-folder-name">${name}</span>
                    `;
                    
                    const folderChildren = document.createElement('div');
                    folderChildren.className = 'tree-folder-children';
                    
                    folderHeader.onclick = () => {
                        folderHeader.classList.toggle('expanded');
                        folderChildren.classList.toggle('expanded');
                    };
                    
                    folder.appendChild(folderHeader);
                    folder.appendChild(folderChildren);
                    container.appendChild(folder);
                    
                    renderTree(node.children, folderChildren, level + 1);
                    
                } else if (node.type === 'file') {
                    const fileContainer = document.createElement('div');
                    fileContainer.className = 'tree-file-container';
                    
                    const fileHeader = document.createElement('div');
                    fileHeader.className = 'tree-file';
                    fileHeader.innerHTML = `
                        <span class="tree-file-icon">‚ñ∂</span>
                        <span class="tree-file-name">${name}</span>
                    `;
                    
                    const functionsContainer = document.createElement('div');
                    functionsContainer.className = 'tree-file-functions';
                    
                    fileHeader.onclick = () => {
                        fileHeader.classList.toggle('expanded');
                        functionsContainer.classList.toggle('expanded');
                    };
                    
                    const functions = node.data.functions.sort((a, b) => a.name.localeCompare(b.name));
                    
                    for (const func of functions) {
                        const item = document.createElement('div');
                        item.className = 'function-item';
                        item.dataset.fullName = func.full_name;
                        
                        const name = document.createElement('div');
                        name.className = 'function-item-name';
                        const displayName = func.class_name ? `${func.class_name}.${func.name}` : func.name;
                        name.textContent = displayName;
                        item.appendChild(name);
                        
                        const info = document.createElement('div');
                        info.className = 'function-item-info';
                        const assertionText = func.assertions_count > 0 ? ` ¬∑ ${func.assertions_count} assertions` : '';
                        info.textContent = `Lines ${func.line_start}-${func.line_end} ¬∑ ${func.callers_count} callers ¬∑ ${func.callees_count} callees${assertionText}`;
                        item.appendChild(info);
                        
                        const actions = document.createElement('div');
                        actions.style.marginTop = '0.25rem';
                        actions.style.display = 'flex';
                        actions.style.gap = '0.25rem';
                        
                        const graphBtn = document.createElement('button');
                        graphBtn.className = 'btn btn-primary';
                        graphBtn.style.padding = '0.25rem 0.5rem';
                        graphBtn.style.fontSize = '0.75rem';
                        graphBtn.textContent = 'View Graph';
                        graphBtn.onclick = (e) => {
                            e.stopPropagation();
                            loadFunctionGraph(func.full_name, func.name);
                        };
                        actions.appendChild(graphBtn);
                        
                        item.appendChild(actions);
                        functionsContainer.appendChild(item);
                    }
                    
                    fileContainer.appendChild(fileHeader);
                    fileContainer.appendChild(functionsContainer);
                    container.appendChild(fileContainer);
                }
            }
        }
        
        async function loadFunctionGraph(fullName, displayName) {
            const graphContent = document.getElementById('graphContent');
            graphContent.innerHTML = '<div class="loading"><div class="spinner"></div><p>Generating graph...</p></div>';
            
            document.getElementById('graphTitle').textContent = `Function: ${displayName}`;
            
            document.querySelectorAll('.function-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const activeItem = document.querySelector(`[data-full-name="${fullName}"]`);
            if (activeItem) {
                activeItem.classList.add('active');
            }
            
            try {
                const response = await fetch(`/api/graph/function/${encodeURIComponent(fullName)}`);
                const data = await response.json();
                
                if (data.success) {
                    const svgResponse = await fetch(`/${data.path}`);
                    const svgText = await svgResponse.text();
                    
                    let assertionsHtml = '';
                    if (data.function.assertions && data.function.assertions.length > 0) {
                        assertionsHtml = `
                            <div class="assertions-section">
                                <div class="assertions-header">
                                    Assertions <span class="assertion-badge">${data.function.assertions.length}</span>
                                </div>
                                ${data.function.assertions.map((assertion, idx) => 
                                    `<div class="assertion-item">${idx + 1}. ${escapeHtml(assertion)}</div>`
                                ).join('')}
                            </div>
                        `;
                    } else {
                        assertionsHtml = `
                            <div class="assertions-section">
                                <div class="assertions-header">Assertions</div>
                                <div class="no-assertions">No assertions found in this function</div>
                            </div>
                        `;
                    }
                    
                    let callersHtml = '';
                    if (data.function.callers_code && data.function.callers_code.length > 0) {
                        callersHtml = `
                            <div class="collapsible-section">
                                <div class="collapsible-header" onclick="toggleCollapsible(this)">
                                    <div class="collapsible-title">
                                        <span>Callers</span>
                                        <span class="collapsible-badge">${data.function.callers_code.length}</span>
                                    </div>
                                    <span class="collapsible-toggle">‚ñ∂</span>
                                </div>
                                <div class="collapsible-content">
                                    <div class="collapsible-body">
                                        ${data.function.callers_code.map((caller, idx) => `
                                            <div class="function-code-item">
                                                <div class="function-code-header">
                                                    <strong>${caller.class_name ? caller.class_name + '.' : ''}${caller.name}</strong>
                                                    <span class="function-code-meta"> ¬∑ ${caller.file} (Lines ${caller.lines})</span>
                                                </div>
                                                <div class="code-viewer-body">
                                                    <pre><code class="language-python caller-code-${idx}"></code></pre>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    let calleesHtml = '';
                    if (data.function.callees_code && data.function.callees_code.length > 0) {
                        calleesHtml = `
                            <div class="collapsible-section">
                                <div class="collapsible-header" onclick="toggleCollapsible(this)">
                                    <div class="collapsible-title">
                                        <span>Callees</span>
                                        <span class="collapsible-badge">${data.function.callees_code.length}</span>
                                    </div>
                                    <span class="collapsible-toggle">‚ñ∂</span>
                                </div>
                                <div class="collapsible-content">
                                    <div class="collapsible-body">
                                        ${data.function.callees_code.map((callee, idx) => `
                                            <div class="function-code-item">
                                                <div class="function-code-header">
                                                    <strong>${callee.class_name ? callee.class_name + '.' : ''}${callee.name}</strong>
                                                    <span class="function-code-meta"> ¬∑ ${callee.file} (Lines ${callee.lines})</span>
                                                </div>
                                                <div class="code-viewer-body">
                                                    <pre><code class="language-python callee-code-${idx}"></code></pre>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    graphContent.innerHTML = `
                        <div class="content-wrapper">
                            ${assertionsHtml}
                            <div class="function-legend">
                                <div class="legend-item">
                                    <div class="legend-box legend-current"></div>
                                    <span>Current Function</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-box legend-caller"></div>
                                    <span>Callers (${data.function.callers} functions)</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-box legend-callee"></div>
                                    <span>Callees (${data.function.callees} functions)</span>
                                </div>
                            </div>
                            <div class="graph-container" id="svgContainer">
                                ${svgText}
                                <div class="zoom-controls">
                                    <button class="zoom-btn" id="zoomIn" title="Zoom In">+</button>
                                    <button class="zoom-btn" id="zoomOut" title="Zoom Out">‚àí</button>
                                    <button class="zoom-btn" id="zoomReset" title="Reset Zoom">‚ü≤</button>
                                </div>
                                <div class="zoom-info" id="zoomInfo">100%</div>
                            </div>
                            <div class="collapsible-section">
                                <div class="collapsible-header active" onclick="toggleCollapsible(this)">
                                    <div class="collapsible-title">
                                        <span>Source Code: ${data.function.class_name ? data.function.class_name + '.' : ''}${data.function.name}</span>
                                    </div>
                                    <span class="collapsible-toggle">‚ñ∂</span>
                                </div>
                                <div class="collapsible-content expanded">
                                    <div class="code-viewer-body">
                                        <pre><code class="language-python" id="functionCode"></code></pre>
                                    </div>
                                </div>
                            </div>
                            ${callersHtml}
                            ${calleesHtml}
                        </div>
                    `;
                    
                    const callerNames = data.function.callers_code ? data.function.callers_code.map(c => c.name) : [];
                    const calleeNames = data.function.callees_code ? data.function.callees_code.map(c => c.name) : [];
                    const callerClasses = data.function.callers_code ? data.function.callers_code
                        .filter(c => c.class_name)
                        .map(c => c.class_name) : [];
                    const calleeClasses = data.function.callees_code ? data.function.callees_code
                        .filter(c => c.class_name)
                        .map(c => c.class_name) : [];
                    const currentName = data.function.name;
                    const currentClass = data.function.class_name;
                    
                    document.getElementById('functionCode').textContent = data.function.source_code;
                    hljs.highlightElement(document.getElementById('functionCode'));
                    highlightAsserts(document.getElementById('functionCode'));
                    highlightFunctions(document.getElementById('functionCode'), currentName, callerNames, calleeNames, null, currentClass, callerClasses, calleeClasses);
                    
                    if (data.function.callers_code) {
                        data.function.callers_code.forEach((caller, idx) => {
                            const elem = document.querySelector(`.caller-code-${idx}`);
                            if (elem) {
                                elem.textContent = caller.source_code;
                                hljs.highlightElement(elem);
                                highlightAsserts(elem);
                                highlightFunctions(elem, caller.name, callerNames, calleeNames, currentName, caller.class_name, callerClasses, calleeClasses);
                            }
                        });
                    }
                    
                    if (data.function.callees_code) {
                        data.function.callees_code.forEach((callee, idx) => {
                            const elem = document.querySelector(`.callee-code-${idx}`);
                            if (elem) {
                                elem.textContent = callee.source_code;
                                hljs.highlightElement(elem);
                                highlightAsserts(elem);
                                highlightFunctions(elem, callee.name, callerNames, calleeNames, currentName, callee.class_name, callerClasses, calleeClasses);
                            }
                        });
                    }
                    
                    initializeSVGPanZoom();
                } else {
                    graphContent.innerHTML = `
                        <div class="empty-state">
                            <p>Error: ${data.error}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading graph:', error);
                graphContent.innerHTML = `
                    <div class="empty-state">
                        <p>Error generating graph</p>
                    </div>
                `;
            }
        }
        
        async function loadProjectGraph() {
            const graphContent = document.getElementById('graphContent');
            graphContent.innerHTML = '<div class="loading"><div class="spinner"></div><p>Generating project graph...</p></div>';
            
            document.getElementById('graphTitle').textContent = 'Project Call Graph';
            
            document.querySelectorAll('.function-item').forEach(item => {
                item.classList.remove('active');
            });
            
            try {
                const response = await fetch('/api/graph/project');
                const data = await response.json();
                
                if (data.success) {
                    const svgResponse = await fetch(`/${data.path}`);
                    const svgText = await svgResponse.text();
                    
                    graphContent.innerHTML = `
                        <div class="graph-container" id="svgContainer">
                            ${svgText}
                            <div class="zoom-controls">
                                <button class="zoom-btn" id="zoomIn" title="Zoom In">+</button>
                                <button class="zoom-btn" id="zoomOut" title="Zoom Out">‚àí</button>
                                <button class="zoom-btn" id="zoomReset" title="Reset Zoom">‚ü≤</button>
                            </div>
                            <div class="zoom-info" id="zoomInfo">100%</div>
                        </div>
                    `;
                    
                    initializeSVGPanZoom();
                } else {
                    graphContent.innerHTML = `
                        <div class="empty-state">
                            <p>Error: ${data.error}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading project graph:', error);
                graphContent.innerHTML = `
                    <div class="empty-state">
                        <p>Error generating project graph</p>
                    </div>
                `;
            }
        }
        
        async function showProjectTree() {
            const graphContent = document.getElementById('graphContent');
            graphContent.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading project tree...</p></div>';
            
            document.getElementById('graphTitle').textContent = 'Project Structure';
            
            document.querySelectorAll('.function-item').forEach(item => {
                item.classList.remove('active');
            });
            
            try {
                const response = await fetch('/api/project/tree');
                const data = await response.json();
                
                let treeHtml = '<div class="tree-view">';
                treeHtml += `<div class="tree-item tree-item-dir">${data.root}</div>`;
                
                for (const item of data.tree) {
                    const className = item.is_dir ? 'tree-item-dir' : 'tree-item-file';
                    treeHtml += `<div class="tree-item ${className}">${item.name}</div>`;
                }
                
                treeHtml += '</div>';
                
                graphContent.innerHTML = `
                    <div class="graph-container">
                        ${treeHtml}
                    </div>
                `;
            } catch (error) {
                console.error('Error loading tree:', error);
                graphContent.innerHTML = `
                    <div class="empty-state">
                        <p>Error loading project tree</p>
                    </div>
                `;
            }
        }
        
        async function showAssertions() {
            const graphContent = document.getElementById('graphContent');
            graphContent.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading assertions...</p></div>';
            
            document.getElementById('graphTitle').textContent = 'Project Assertions';
            
            document.querySelectorAll('.function-item').forEach(item => {
                item.classList.remove('active');
            });
            
            try {
                const response = await fetch('/api/project/assertions');
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error);
                }
                
                let contentHtml = '';
                
                if (data.summary.total_assertions === 0) {
                    contentHtml = `
                        <div class="empty-state">
                            <div class="empty-state-icon">‚ö†Ô∏è</div>
                            <h3>No Assertions Found</h3>
                            <p>None of the functions in the project contain assertions</p>
                        </div>
                    `;
                } else {
                    contentHtml = `
                        <div class="assertions-summary">
                            <h3>Assertions Summary</h3>
                            <div class="summary-stats">
                                <div class="stat-item">
                                    <span class="stat-label">Total Functions:</span>
                                    <span class="stat-value">${data.summary.total_functions}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Functions with Assertions:</span>
                                    <span class="stat-value">${data.summary.functions_with_assertions}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Total Assertions:</span>
                                    <span class="stat-value">${data.summary.total_assertions}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Average per Function:</span>
                                    <span class="stat-value">${data.summary.average.toFixed(2)}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="function-assertions-list">
                    `;
                    
                    for (const func of data.functions) {
                        contentHtml += `
                            <div class="function-assertion-card">
                                <h4>${func.name}</h4>
                                <div class="function-meta">
                                    ${func.file} (Lines ${func.lines}) ¬∑ ${func.assertion_count} assertion${func.assertion_count > 1 ? 's' : ''}
                                </div>
                        `;
                        
                        func.assertions.forEach((assertion, idx) => {
                            contentHtml += `<div class="assertion-item">${idx + 1}. ${escapeHtml(assertion)}</div>`;
                        });
                        
                        contentHtml += `</div>`;
                    }
                    
                    contentHtml += `</div>`;
                }
                
                graphContent.innerHTML = contentHtml;
                
            } catch (error) {
                console.error('Error loading assertions:', error);
                graphContent.innerHTML = `
                    <div class="empty-state">
                        <p>Error loading assertions: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        let svgState = {
            scale: 1,
            translateX: 0,
            translateY: 0,
            isDragging: false,
            startX: 0,
            startY: 0
        };
        
        async function loadProjectDirectory() {
            try {
                const response = await fetch('/api/project/directory');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('projectDirInput').value = data.directory;
                }
            } catch (error) {
                console.error('Error loading project directory:', error);
            }
        }
        
        async function setProjectDirectory() {
            const newDir = document.getElementById('projectDirInput').value.trim();
            
            if (!newDir) {
                alert('Please enter a directory path');
                return;
            }
            
            try {
                const response = await fetch('/api/project/directory', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ directory: newDir })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('projectDirInput').value = data.directory;
                    loadFunctions();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error setting project directory:', error);
                alert('Error setting project directory');
            }
        }
        
        function initializeSVGPanZoom() {
            const container = document.getElementById('svgContainer');
            const svg = container.querySelector('svg');
            const zoomInfo = document.getElementById('zoomInfo');
            
            if (!svg) return;
            
            svgState = {
                scale: 1,
                translateX: 0,
                translateY: 0,
                isDragging: false,
                startX: 0,
                startY: 0
            };
            
            updateSVGTransform(svg);
            
            document.getElementById('zoomIn').addEventListener('click', () => {
                svgState.scale = Math.min(svgState.scale * 1.2, 10);
                updateSVGTransform(svg);
                updateZoomInfo(zoomInfo);
            });
            
            document.getElementById('zoomOut').addEventListener('click', () => {
                svgState.scale = Math.max(svgState.scale / 1.2, 0.1);
                updateSVGTransform(svg);
                updateZoomInfo(zoomInfo);
            });
            
            document.getElementById('zoomReset').addEventListener('click', () => {
                svgState.scale = 1;
                svgState.translateX = 0;
                svgState.translateY = 0;
                updateSVGTransform(svg);
                updateZoomInfo(zoomInfo);
            });
            
            container.addEventListener('wheel', (e) => {
                e.preventDefault();
                
                const rect = container.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                
                const delta = e.deltaY > 0 ? 0.9 : 1.1;
                const newScale = Math.min(Math.max(svgState.scale * delta, 0.1), 10);
                
                const scaleChange = newScale / svgState.scale;
                svgState.translateX = mouseX - (mouseX - svgState.translateX) * scaleChange;
                svgState.translateY = mouseY - (mouseY - svgState.translateY) * scaleChange;
                svgState.scale = newScale;
                
                updateSVGTransform(svg);
                updateZoomInfo(zoomInfo);
            }, { passive: false });
            
            container.addEventListener('mousedown', (e) => {
                if (e.target.closest('.zoom-controls') || e.target.closest('.zoom-info')) return;
                
                svgState.isDragging = true;
                svgState.startX = e.clientX - svgState.translateX;
                svgState.startY = e.clientY - svgState.translateY;
                container.classList.add('grabbing');
            });
            
            container.addEventListener('mousemove', (e) => {
                if (!svgState.isDragging) return;
                
                svgState.translateX = e.clientX - svgState.startX;
                svgState.translateY = e.clientY - svgState.startY;
                updateSVGTransform(svg);
            });
            
            container.addEventListener('mouseup', () => {
                svgState.isDragging = false;
                container.classList.remove('grabbing');
            });
            
            container.addEventListener('mouseleave', () => {
                svgState.isDragging = false;
                container.classList.remove('grabbing');
            });
            
            container.addEventListener('touchstart', (e) => {
                if (e.touches.length === 1) {
                    const touch = e.touches[0];
                    svgState.isDragging = true;
                    svgState.startX = touch.clientX - svgState.translateX;
                    svgState.startY = touch.clientY - svgState.translateY;
                }
            });
            
            container.addEventListener('touchmove', (e) => {
                if (svgState.isDragging && e.touches.length === 1) {
                    e.preventDefault();
                    const touch = e.touches[0];
                    svgState.translateX = touch.clientX - svgState.startX;
                    svgState.translateY = touch.clientY - svgState.startY;
                    updateSVGTransform(svg);
                }
            }, { passive: false });
            
            container.addEventListener('touchend', () => {
                svgState.isDragging = false;
            });
            
            updateZoomInfo(zoomInfo);
        }
        
        function updateSVGTransform(svg) {
            svg.style.transform = `translate(${svgState.translateX}px, ${svgState.translateY}px) scale(${svgState.scale})`;
        }
        
        function updateZoomInfo(element) {
            element.textContent = `${Math.round(svgState.scale * 100)}%`;
        }
        
        function toggleCollapsible(header) {
            header.classList.toggle('active');
            const content = header.nextElementSibling;
            content.classList.toggle('expanded');
        }
        
        function highlightAsserts(codeElement) {
            const html = codeElement.innerHTML;
            const highlightedHtml = html.replace(
                /(<span class="hljs-keyword">)(assert)(<\/span>)/gi,
                '$1<span style="background-color: #fff3cd; padding: 0.125rem 0.25rem; border-radius: 3px; color: #e45649; font-weight: 700;">$2</span>$3'
            );
            codeElement.innerHTML = highlightedHtml;
        }
        
        function highlightFunctions(codeElement, currentFunc, callers, callees, mainFunc = null, currentClass = null, callerClasses = [], calleeClasses = []) {
            let html = codeElement.innerHTML;
            
            const allFunctions = new Set();
            if (currentFunc) allFunctions.add(currentFunc);
            if (mainFunc) allFunctions.add(mainFunc);
            callers.forEach(name => allFunctions.add(name));
            callees.forEach(name => allFunctions.add(name));
            
            allFunctions.forEach(funcName => {
                const escapedName = funcName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const regex = new RegExp(`\\b(${escapedName})\\b(?=\\s*\\()`, 'g');
                
                html = html.replace(regex, (match, p1) => {
                    let className = '';
                    let title = '';
                    
                    if (p1 === currentFunc) {
                        className = 'highlight-current';
                        title = `Current function: ${p1}`;
                    } else if (p1 === mainFunc) {
                        className = 'highlight-current';
                        title = `Main function: ${p1}`;
                    } else if (callers.includes(p1)) {
                        className = 'highlight-caller';
                        title = `Caller: ${p1}`;
                    } else if (callees.includes(p1)) {
                        className = 'highlight-callee';
                        title = `Callee: ${p1}`;
                    }
                    
                    if (className) {
                        return `<span class="${className}" title="${title}">${p1}</span>`;
                    }
                    return match;
                });
            });
            
            const allClasses = new Set();
            if (currentClass) allClasses.add(currentClass);
            callerClasses.forEach(cls => allClasses.add(cls));
            calleeClasses.forEach(cls => allClasses.add(cls));
            
            allClasses.forEach(className => {
                const escapedName = className.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const regex = new RegExp(`\\b(${escapedName})\\b(?=\\s*\\()`, 'g');
                
                html = html.replace(regex, (match, p1) => {
                    let cssClass = '';
                    let title = '';
                    
                    if (p1 === currentClass) {
                        cssClass = 'highlight-current';
                        title = `Current class: ${p1}() calls __init__`;
                    } else if (callerClasses.includes(p1)) {
                        cssClass = 'highlight-caller';
                        title = `Caller class: ${p1}() calls __init__`;
                    } else if (calleeClasses.includes(p1)) {
                        cssClass = 'highlight-callee';
                        title = `Callee class: ${p1}() calls __init__`;
                    }
                    
                    if (cssClass) {
                        return `<span class="${cssClass}" title="${title}">${p1}</span>`;
                    }
                    return match;
                });
            });
            
            codeElement.innerHTML = html;
        }
        
        loadProjectDirectory();
        loadFunctions();
    </script>
</body>
</html>
